/*
 Leaflet.orientedmarker, Provides dynamic orientation functionality for Leaflet markers.
 https://github.com/gismartwaredev/leaflet.orientedMarker
 (c) 2015, Alexandre DAVID (http://github.com/alexandreDavid), GiSmartware
*/
!function(t,i){L.OrientedMarker=L.Marker.extend({options:{angle:0,orientationLineColor:"red",orientationLineWeight:5,orientationLineOpacity:.8},isOriented:!0,_setPos:function(t){L.Marker.prototype._setPos.call(this,t),this._initIconStyle=this._icon.style[L.DomUtil.TRANSFORM]+"",this._updateImg()},_updateImg:function(t,i,n){var t,n,i=this.options.icon.options.iconAnchor;this._icon&&(t=this._icon,n=this.options.icon.options.iconSize,this._orienteIcon(t,i,n)),this._shadow&&(n=this.options.icon.options.shadowSize,t=this._shadow,this._orienteIcon(t,i,n))},_orienteIcon:function(t,i,n){if(!n)return void(t.style[L.DomUtil.TRANSFORM]=this._initIconStyle+" rotate("+this.options.angle+"deg)");i=L.point(n).divideBy(2)._subtract(L.point(i));var o="";o+=" translate("+-i.x+"px, "+-i.y+"px)",o+=" rotate("+this.options.angle+"deg)",o+=" translate("+i.x+"px, "+i.y+"px)",t.style[L.DomUtil.TRANSFORM]=this._initIconStyle+" "+o},onRemove:function(t){return this._orientationLine.onRemove(this._map),this._orientationCircle.onRemove(this._map),L.Marker.prototype.onRemove.call(this,t),this},update:function(){return L.Marker.prototype.update.call(this),this._orientationLine&&this.activateOrientation(),this},activateOrientation:function(){function t(){a._savedDragging=a._map.dragging,a._savedMouseUp=i.onmouseup,a._map.dragging.disable(),a._orientationMouseDown=!0}function n(t){if(a._orientationMouseDown){var i=t.changedTouches,n=i[i.length-1];newLatLng=a._map.layerPointToLatLng(a._map.mouseEventToLayerPoint({clientX:n.pageX,clientY:n.pageY})),o({latlng:newLatLng})}}function o(t){if(a._orientationMouseDown){var i=new L.LatLng(t.latlng.lat,t.latlng.lng);a._orientationLine.setLatLngs([a._latlng,i]),a._orientationCircle.setLatLng(i),a._setAngle()}}function e(){a._orientationMouseDown&&(a._orientationMouseDown=!1,a._map.dragging.enable(),a._setAngle())}var a=this;return a._setOrientationDirectionLine(),a._orientationMouseDown=!1,a._orientationLine.addTo(a._map),a._orientationCircle.addTo(a._map),(a._orientationLine,a._orientationCircle).on("mousedown",t),a._map.on("mousemove",o),i.onmouseup=e,a._orientationLine._container.ontouchstart=t,a._orientationCircle._container.ontouchstart=t,a._orientationCircle._container.ontouchmove=n,a._orientationCircle._container.ontouchmove=n,a._orientationCircle._container.ontouchend=e,a._orientationCircle._container.ontouchend=e,a},_setOrientationDirectionLine:function(){this._orientationLine&&(this._map.removeLayer(this._orientationLine),this._map.removeLayer(this._orientationCircle));var t=new L.Transformation(1,100*Math.sin(this.options.angle*Math.PI/180),1,-100*Math.cos(this.options.angle*Math.PI/180)),i=this._map.layerPointToLatLng(t.transform(this._map.latLngToLayerPoint(this._latlng))),n=[this._latlng,i];this._orientationLine=new L.Polyline(n,{color:this.options.orientationLineColor,weight:this.options.orientationLineWeight,opacity:this.options.orientationLineOpacity,smoothFactor:1}),this._orientationCircle=new L.circleMarker(i,{radius:2*this.options.orientationLineWeight,color:this.options.orientationLineColor,fillColor:this.options.orientationLineColor,fillOpacity:this.options.orientationLineOpacity})},_orientationMouseDown:!1,_savedDragging:!1,_savedMouseUp:!1,validOrientation:function(){return this._map.dragging=this._savedDragging,i.onmouseup=this._savedMouseUp,this._orientationLine.onRemove(this._map),this._orientationCircle.onRemove(this._map),this},_setAngle:function(){var t=this._orientationLine._parts[0][0],i=this._orientationLine._parts[0][1];this.options.angle=180*(Math.atan2(0,1)-Math.atan2(i.x-t.x,i.y-t.y))/Math.PI+180,this._updateImg()},_initIconStyle:!1,_orientationLine:!1,_orientationCircle:!1}),L.orientedMarker=function(t,i){return new L.OrientedMarker(t,i)}}(window,document);